<!DOCTYPE html>
<html lang="en">

<head>
    <title>Oficinas MTIS</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="js/stomp.js"></script>
    <script>
        var user = null;
        var password = null;
        var client = Stomp.client("ws://localhost:61614"); // configurar!!!
        client.connect(user, password, onconnect, onerror);

        function onconnect() {
            console.log("Se ha conectado")
        }

        function onerror() {
            // manejamos el error
            console.log("Ha ocurrido un error")

        }
    </script>
</head>

<body>

    <div class="container">
        <h1>Oficinas Disponibles</h1>
        <hr>
        <div class="row">
            <div class="col-md-12" style="text-align:center">
                <div class="col-md-5">
                    <div class="panel panel-default">
                        <div class="panel-heading">Oficina 1</div>
                        <div class="panel-body">
                            <p class="pull-left">200lm</p>
                            <span id="dialog_title_span" style="text-align:center">
                                
                            </span>
                            <i id="flechaArriba" class="fa fa-arrow-up" style="visibility: hidden"></i>
                                <i id="flechaAbajo" class="fa fa-arrow-down" style="visibility: hidden"></i>
                            <p class="pull-right">1000lm</p>
                            <div class="progress">
                                <div class="progress-bar progress-bar-info" id="luzOficina1" role="progressbar" aria-valuenow="600" aria-valuemin="200" aria-valuemax="1000"
                                    style="width:0%">
                                </div>

                                <br/>
                                <input id="inputLuzOficina1" value="600">
                                <input id="inputLuzOficina1Accion">
                            </div>
                            <div>
                                <p class="pull-left">0</p>
                                <p style="margin-left:90%">50</p>
                                <div class="progress">
                                    <div class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="40" aria-valuemin="200" aria-valuemax="1000"
                                        style="width:40%">
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
                <div class="col-md-2" style="text-align:center; margin-top:70px">
                    <div class="panel panel-default">
                        <div class="panel-body">LUZ</div>
                    </div>
                    <div class="panel panel-default">
                        <div class="panel-body">TEMPERATURA</div>
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="panel panel-default">
                        <div class="panel-heading">Oficina 2</div>
                        <div class="panel-body">
                            <div>
                                <p class="pull-left">200lm</p>
                                <p style="margin-left:90%">1000lm</p>
                                <div class="progress">
                                    <div class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="40" aria-valuemin="200" aria-valuemax="1000"
                                        style="width:40%">
                                        40% Complete (success)
                                    </div>
                                </div>
                            </div>
                            <div>
                                <p class="pull-left">0</p>
                                <p style="margin-left:90%">50</p>
                                <div class="progress">
                                    <div class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="40" aria-valuemin="200" aria-valuemax="1000"
                                        style="width:40%">
                                        <span id="current-progress-luz1"></span>
                                        40% Complete (success)
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>
<script>
    $(document).ready(function valoresAleatoriosSubirBajar() {
        x = 30;  // 5 Seconds
        var actual = document.getElementById("inputLuzOficina1Accion").value
        var accion = Math.floor(Math.random() * 5) + 0
        console.log(accion)
        if (accion > 2) {
            document.getElementById("inputLuzOficina1Accion").value = "subir"
        } else {
            document.getElementById("inputLuzOficina1Accion").value = "bajar"
        }
        setTimeout(valoresAleatoriosSubirBajar, x * 1000);
    })
</script>
<!-- OFICINA 1 -->
<script>
    $(document).ready(function enviarInformacion() {
        x = 10;  // 5 Seconds
        var valorActual = document.getElementById("inputLuzOficina1").value
        var message = "null"
        console.log(message)
        console.log(valorActual)
        if (valorActual >= 850)
            message = "bajarLuz"
        if (valorActual <= 350)
            message = "subirLuz"
        console.log(message)

        sendMessage(message)

        function sendMessage(message) {
            client.send('/topic/activador.activador1', {}, message);
        }
        setTimeout(enviarInformacion, x * 1000);
    })
</script>
</script>
<!-- ACTIVADOR LUZ OFICINA 1 -->
<script>   
    var activador = "activadorLuz1";
    $(document).ready(function subscribeMessageQueue() {
        console.log("Estoy suscrito")
        client.subscribe('/topic/activador.activador1', processMessage);
    })

    function processMessage(message) {
        var messageBody = message.body;
        console.log("Recibo mensaje")
        console.log(message)

        if (messageBody == "subirLuz") {
            document.getElementById("inputLuzOficina1Accion").value = "subir"
            $('#dialog_title_span').text('Regulando luces:');
            $('#flechaArriba').css("visibility", "visible");

        } else if (messageBody == "bajarLuz") {
            document.getElementById("inputLuzOficina1Accion").value = "bajar"
            $('#dialog_title_span').text('Regulando luces: ');
            $('#flechaAbajo').css("visibility", "visible");

        } else {
            $('#dialog_title_span').text("");
            $('#flechaArriba').css("visibility", "hidden")
            $('#flechaAbajo').css("visibility", "hidden")
        }
    }
</script>
<!-- SENSOR LUZ OFICINA 1 -->
<script>
    $(document).ready(function sensorLuzOficina1() {
        x = 3;  // 5 Seconds
        var actual = document.getElementById("inputLuzOficina1").value
        var accion = document.getElementById("inputLuzOficina1Accion").value
        if (accion == "subir") {
            for (i = 0; i < Math.floor(Math.random() * 80) + 20; i++) {
                actual++
                if (actual >= 1000) {
                    actual = 1000
                }

            }
        } else {
            for (i = 0; i < Math.floor(Math.random() * 80) + 20; i++) {
                actual--
                if (actual <= 200) {
                    actual = 200
                }
            }
        }


        porcentaje = (actual - 200) * 0.125


        $("#luzOficina1")
            .removeClass("progress-bar-danger")
            .addClass("progress-bar-info")
            .css("width", porcentaje + "%")
            .attr("aria-valuenow", actual)
            .text(actual);
        if (actual <= 400) {
            $("#luzOficina1")
                .removeClass("progress-bar-info")
                .addClass("progress-bar-danger")
                .css("width", porcentaje + "%")
                .attr("aria-valuenow", actual)
                .text(actual);
        } else if (actual >= 800) {
            $("#luzOficina1")
                .removeClass("progress-bar-info")
                .addClass("progress-bar-danger")
                .css("width", porcentaje + "%")
                .attr("aria-valuenow", actual)
                .text(actual);
        }


        document.getElementById("inputLuzOficina1").value = actual
        setTimeout(sensorLuzOficina1, x * 1000);

    })
</script>

</html>